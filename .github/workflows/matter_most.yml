name: Notify Mattermost on Push

on:
  push:
    branches: ["**"]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Build payload JSON
        env:
          GITHUB_EVENT: ${{ toJson(github.event) }}
          REPO:   ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR:  ${{ github.actor }}
        run: |
          node -e '
            const evt = JSON.parse(process.env.GITHUB_EVENT || "{}");
            const commits = (evt.commits||[]).map(c => `- ${c.message} (${c.id.slice(0,7)})`).join("\n") || "- (no commit messages)";
            const text =
              `*${process.env.REPO}*에 push event 발생\n` +
              `브랜치: \`${process.env.BRANCH}\`\n작성자: ${process.env.ACTOR}\n\n` +
              commits;
            require("fs").writeFileSync("payload.json", JSON.stringify({ text }));
          '

      - name: Send to Mattermost
        run: |
          curl -sS -X POST \
            -H 'Content-Type: application/json' \
            --data-binary @payload.json \
            'https://meeting.ssafy.com/hooks/4qcxaequ5ido7b4yjbxog1e3fo' \
            -w '\nHTTP %{http_code}\n'
