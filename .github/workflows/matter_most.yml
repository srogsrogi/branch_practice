name: Notify Mattermost on Push

on:
  push:            # ëª¨ë“  ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
    branches: ["**"]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Build payload JSON
        run: |
          REPO="${GITHUB_REPOSITORY}"
          BRANCH="${GITHUB_REF_NAME}"
          ACTOR="${GITHUB_ACTOR}"

          # ì»¤ë°‹ ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸°
          node -e '
            const evt = JSON.parse(process.env.GITHUB_EVENT || "{}");
            const commits = (evt.commits||[]).map(c => `- ${c.message} (${c.id.slice(0,7)})`).join("\n") || "- (no commit messages)";
            const text =
              `ğŸ“¢ *${process.env.REPO}*ì— push ë°œìƒ\n` +
              `ë¸Œëœì¹˜: \`${process.env.BRANCH}\`\nì‘ì„±ì: ${process.env.ACTOR}\n\n` +
              commits;
            require("fs").writeFileSync("payload.json", JSON.stringify({text}));
          ' 

        env:
          GITHUB_EVENT: ${{ toJson(github.event) }}
          REPO:   ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR:  ${{ github.actor }}

      - name: Send to Mattermost
        run: |
          curl -sS -X POST \
            -H 'Content-Type: application/json' \
            --data-binary @payload.json \
            '${{ secrets.MATTERMOST_WEBHOOK_URL }}'
